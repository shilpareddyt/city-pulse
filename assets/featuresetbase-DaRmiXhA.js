import{gk as m,gl as p,gq as C,bZ as De,gp as v,gs as xe,C as ue,a$ as Ee,gt as Ne,fT as Fe,bW as P,gu as Ae,bw as ve,ad as Se}from"./index-DeoyqcX0.js";import{t as Le,D as Ce,l as $}from"./arcade-4aejH_PE.js";import{a as E,i as Ze,k as ee,K as S,j,p as N,S as ke,l as ce,o as me,X as pe,q as Z,T as H,$ as B,b as W,G as Pe,N as G,u as Re,L as Q}from"./aiServices-N9qOS0DJ.js";import{R as je,q as ye,p as Ue,c as ne,e as Me,a as Oe,b as ze,N as X,j as We,F as He,E as Ge,L as z,B as Ve,d as J,f as k,k as te}from"./featureSetUtils-BL1IQ9GV.js";import{t as Ke}from"./ImmutableArray-BPVd6ESQ.js";import{l as qe}from"./portalUtils-CZXqZoAq.js";import{u as _e,O as we}from"./SpatialFilter-CT2YndQ9.js";import{x as ge,s as ie}from"./shared-Bqikc-7C.js";import{R as x}from"./WhereClause-BTLqiOr7.js";import{queryAssociations as Be}from"./queryAssociations-tkG10iGN.js";import Qe from"./QueryAssociationsParameters-DGlGmGZD.js";import"./featureConversionUtils-ByczMuu5.js";import"./OptimizedFeature-DKoLIRUo.js";import"./memoryEstimations-CZsmjxnE.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./unitConversion-DT0_f0ke.js";import"./number-G1TN47Ng.js";import"./commonProperties-DHiB1uzW.js";import"./operatorsWorkerConnection-BuQzT27n.js";import"./Association-QSxpohdZ.js";function Je(a){if(a.length===1){if(v(a[0]))return $("distinct",a[0],-1);if(W(a[0]))return $("distinct",a[0].toArray(),-1)}return $("distinct",a,-1)}function ae(a,w,n){const i=a.getVariables();if(i.length>0){const I={};for(const b of i)I[b]=w.evaluateIdentifier(n,{name:b});a.parameters=I}return a}function d(a,w,n=null){for(const i in a)if(i.toLowerCase()===w.toLowerCase())return a[i];return n}function Ie(a){if(a===null)return null;const w={type:d(a,"type",""),name:d(a,"name","")};if(w.type==="range")w.range=d(a,"range",[]);else{w.codedValues=[];for(const n of d(a,"codedValues",[]))w.codedValues.push({name:d(n,"name",""),code:d(n,"code",null)})}return w}function re(a){if(a===null)return null;const w={},n=d(a,"wkt");n!==null&&(w.wkt=n);const i=d(a,"wkid");return i!==null&&(w.wkid=i),w}function he(a){if(a===null)return null;const w={hasZ:d(a,"hasz",!1),hasM:d(a,"hasm",!1)},n=d(a,"spatialreference");n!=null&&(w.spatialReference=re(n));const i=d(a,"x",null);if(i!==null)return w.x=i,w.y=d(a,"y",null),w.hasZ&&(w.z=d(a,"z",null)),w.hasM&&(w.m=d(a,"m",null)),w;const I=d(a,"rings",null);if(I!==null)return w.rings=I,w;const b=d(a,"paths",null);if(b!==null)return w.paths=b,w;const e=d(a,"points",null);if(e!==null)return w.points=e,w;for(const t of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=d(a,t,null);s!==null&&(w[t]=s)}return w}function Xe(a,w){for(const n of w)if(n===a)return!0;return!1}function Ye(a){return!!a.layerDefinition&&!!a.featureSet&&Xe(a.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&v(a.layerDefinition.fields)!==!1&&v(a.featureSet.features)!==!1}function V(a){return a?.toLowerCase()==="utc"?"UTC":a?.toLowerCase()==="unknown"?"Unknown":a}async function $e(a,w,n,i,I,b,e){const t=await a.getFeatureSetInfo();if((t?.layerId??null)===null||!I.layerIdLookup.get(t.layerId))return null;const s=a.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),o=[];switch(n){case"connected":o.push("connectivity"),o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity"),o.push("junction-edge-midspan-connectivity"),o.push("junction-junction-connectivity");break;case"container":case"content":o.push("containment");break;case"structure":case"attached":o.push("attachment");break;case"junctionedge":o.push("junction-edge-from-connectivity"),o.push("junction-edge-to-connectivity");break;case"midspan":o.push("junction-edge-midspan-connectivity");break;default:throw new m(b,p.InvalidParameter,e)}let y=null,u=!1;if(i!==null&&i!==""&&i!==void 0){for(const f of I.terminals)f.terminalName===i&&(y=f.terminalId);y===null&&(u=!0)}const l=[];if(!u){const f=new ve({globalId:w.field(a.globalIdField),networkSourceId:I.layerIdLookup.get(t.layerId).sourceId,...y?{terminalId:y}:""}),c=await Be(s,new Qe({types:o,elements:[f]}));let A=0;for(const g of c.associations){let h=null,D="",R="";if(g.fromNetworkElement?.globalId===f.globalId?(h=g.toNetworkElement,R="to"):g.toNetworkElement?.globalId===f.globalId&&(h=g.fromNetworkElement,R="from"),!h)continue;switch(n){case"attached":if(g.associationType!=="attachment"||R!=="to")continue;break;case"structure":if(g.associationType!=="attachment"||R!=="from")continue;break;case"container":if(g.associationType!=="containment"||R!=="from")continue;break;case"content":if(g.associationType!=="containment"||R!=="to")continue;break;case"connected":break;case"junctionedge":g.associationType==="junction-edge-to-connectivity"?D="to":g.associationType==="junction-edge-from-connectivity"&&(D="from");break;case"midspan":if(g.associationType!=="junction-edge-midspan-connectivity")continue}const K=I.sourceIdLookup.get(h.networkSourceId)?.className??"";l.push(new Se({geometry:null,attributes:{objectId:A++,globalId:h.globalId,percentAlong:g.percentAlong??0,isContentVisible:g.isContentVisible?0:1,className:K,side:D}}))}}const r=new Fe({source:l,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return X(r)}function bn(a){if(a.mode==="async"){a.functions.timezone=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,1,2,n,i),Ze(e[0])||ee(e[0]))return"Unknown";if(S(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?V("unknown"):V(e[0].dateFieldsTimeZone);if(!(e[1]instanceof j)||e[1].hasField("type")===!1)throw new m(n,p.InvalidParameter,i);const o=e[1].field("type");if(C(o)===!1)throw new m(n,p.InvalidParameter,i);switch(N(o).toLowerCase()){case"preferredtimezone":return V(e[0].preferredTimeZone);case"editfieldsinfo":return V(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return V(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&C(e[1].field("fieldname")))return V(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new m(n,p.InvalidParameter,i)}const t=ke(e[0],ce(n));if(t===null)return null;const s=t.timeZone;return s==="system"?De.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},a.functions.sqltimestamp=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{E(e,1,3,n,i);const t=e[0];if(me(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new m(n,p.InvalidParameter,i)}if(ee(t))return t.toSQLWithKeyword();if(S(t)){if(e.length!==3)throw new m(n,p.InvalidParameter,i);await t.load();const s=N(e[1]);if(ee(e[2]))return e[2].toSQLWithKeyword();if(me(e[2])===!1)throw new m(n,p.InvalidParameter,i);const o=t.fieldTimeZone(s);return o==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(o).toSQLWithKeyword()}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"sqltimestamp",min:2,max:4}),a.functions.featuresetbyid=function(n,i){return a.standardFunctionAsync(n,i,(I,b,e)=>{if(E(e,2,4,n,i),pe(e[0])){const t=N(e[1]);let s=Z(e[2],null);const o=H(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new m(n,p.InvalidParameter,i);return e[0].featureSetById(t,o,s)}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyid",min:2,max:4});const w=new xe(["datasource","parent","root"]);a.functions.getfeatureset=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,1,2,n,i),B(e[0])){const t=e[1]==null?"datasource":w.lookup(N(e[1]));return je(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference)}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"getfeatureset",min:1,max:2}),a.functions.featuresetbyportalitem=function(n,i){return a.standardFunctionAsync(n,i,(I,b,e)=>{if(E(e,2,5,n,i),e[0]===null)throw new m(n,p.PortalRequired,i);if(e[0]instanceof Le){const u=N(e[1]),l=N(e[2]);let r=Z(e[3],null);const f=H(Z(e[4],!0));if(r===null&&(r=["*"]),v(r)===!1)throw new m(n,p.InvalidParameter,i);let c;return c=n.services?.portal?n.services.portal:ue.getDefault(),c=qe(e[0],c),ye(u,l,n.spatialReference,r,f,c,n.lrucache,n.interceptor)}if(C(e[0])===!1)throw new m(n,p.PortalRequired,i);const t=N(e[0]),s=N(e[1]);let o=Z(e[2],null);const y=H(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new m(n,p.InvalidParameter,i);return ye(t,s,n.spatialReference,o,y,n.services?.portal??ue.getDefault(),n.lrucache,n.interceptor)})},a.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),a.functions.featuresetbyname=function(n,i){return a.standardFunctionAsync(n,i,(I,b,e)=>{if(E(e,2,4,n,i),pe(e[0])){const t=N(e[1]);let s=Z(e[2],null);const o=H(Z(e[3],!0));if(s===null&&(s=["*"]),v(s)===!1)throw new m(n,p.InvalidParameter,i);return e[0].featureSetByName(t,o,s)}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyname",min:2,max:4}),a.functions.featureset=function(n,i){return a.standardFunction(n,i,(I,b,e)=>{E(e,1,1,n,i);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(C(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(t.layerDefinition=s.layerDefinition,t.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(t.featureSet.features=s.features,t.featureSet.geometryType=s.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=s.objectIdFieldName??"",t.layerDefinition.typeIdField=s.typeIdFieldName,t.layerDefinition.globalIdField=s.globalIdFieldName,t.layerDefinition.fields=s.fields,s.spatialReference&&(t.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof j))throw new m(n,p.InvalidParameter,i);{const s=JSON.parse(e[0].castToText(!0)),o=d(s,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=d(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=d(o,"globalidfield",""),t.layerDefinition.objectIdField=d(o,"objectidfield",""),t.layerDefinition.typeIdField=d(o,"typeidfield",""),t.layerDefinition.hasZ=d(o,"hasz",!1)===!0,t.layerDefinition.hasM=d(o,"hasm",!1)===!0;const y=d(o,"spatialreference");y&&(t.layerDefinition.spatialReference=re(y));const u=[];for(const r of d(o,"fields",[])){const f={name:d(r,"name",""),alias:d(r,"alias",""),type:d(r,"type",""),nullable:d(r,"nullable",!0),editable:d(r,"editable",!0),length:d(r,"length",null),domain:Ie(d(r,"domain"))};u.push(f)}t.layerDefinition.fields=u;const l=d(s,"featureset");if(l){const r={};for(const f of u)r[f.name.toLowerCase()]=f.name;for(const f of d(l,"features",[])){const c={},A=d(f,"attributes",{});for(const g in A)c[r[g.toLowerCase()]]=A[g];t.featureSet.features.push({attributes:c,geometry:he(d(f,"geometry"))})}}}else{t.layerDefinition.hasZ=d(s,"hasz",!1)===!0,t.layerDefinition.hasM=d(s,"hasm",!1)===!0,t.layerDefinition.geometryType=d(s,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=d(s,"objectidfieldname",""),t.layerDefinition.typeIdField=d(s,"typeidfieldname","");const y=d(s,"spatialreference");y&&(t.layerDefinition.spatialReference=re(y));const u=[],l=d(s,"fields",null);if(!v(l))throw new m(n,p.InvalidParameter,i);for(const c of l){const A={name:d(c,"name",""),alias:d(c,"alias",""),type:d(c,"type",""),nullable:d(c,"nullable",!0),editable:d(c,"editable",!0),length:d(c,"length",null),domain:Ie(d(c,"domain"))};u.push(A)}t.layerDefinition.fields=u;const r={};for(const c of u)r[c.name.toLowerCase()]=c.name;let f=d(s,"features",null);if(v(f))for(const c of f){const A={},g=d(c,"attributes",{});for(const h in g)A[r[h.toLowerCase()]]=g[h];t.featureSet.features.push({attributes:A,geometry:he(d(c,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(Ye(t)===!1)throw new m(n,p.InvalidParameter,i);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Ue.create(t,n.spatialReference)})},a.signatures.push({name:"featureset",min:1,max:1}),a.functions.filter=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,2,2,n,i),v(e[0])||W(e[0])){const t=[];let s,o=e[0];if(o instanceof Ke&&(o=o.toArray()),!Pe(e[1]))throw new m(n,p.InvalidParameter,i);s=e[1].createFunction(n);for(const y of o){const u=s(y);Ee(u)?await u===!0&&t.push(y):u===!0&&t.push(y)}return t}if(S(e[0])){const t=await e[0].load(),s=x.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),o=s.getVariables();if(o.length>0){const y={};for(const u of o)y[u]=a.evaluateIdentifier(n,{name:u});s.parameters=y}return new ne({parentfeatureset:e[0],whereclause:s})}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"filter",min:2,max:2}),a.functions.orderby=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,2,2,n,i),S(e[0])){const t=new Me(e[1]);return new Oe({parentfeatureset:e[0],orderbyclause:t})}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"orderby",min:2,max:2}),a.functions.top=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,2,2,n,i),S(e[0]))return new ze({parentfeatureset:e[0],topnum:e[1]});if(v(e[0]))return G(e[1])>=e[0].length?e[0].slice():e[0].slice(0,G(e[1]));if(W(e[0]))return G(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,G(e[1]));throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"top",min:2,max:2}),a.functions.first=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,1,1,n,i),S(e[0])){const t=await e[0].first(I.abortSignal);if(t!==null){const s=Ce.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return s._underlyingGraphic=t,s}return t}return v(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},a.signatures.push({name:"first",min:1,max:1}),a.functions.attachments=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{E(e,1,2,n,i);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof j){if(e[1].hasField("minsize")&&(t.minsize=G(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=H(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=G(e[1].field("maxsize"))),e[1].hasField("types")){const s=Re(e[1].field("types"),!1);s.length>0&&(t.types=s)}}else if(e[1]!==null)throw new m(n,p.InvalidParameter,i)}if(B(e[0])){const s=e[0]._layer;let o;if(S(s))o=s;else{if(s==null||!ge(s))return[];o=X(s,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata)}if(e[0]===null)return[];throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"attachments",min:1,max:2}),a.functions.featuresetbyrelationshipname=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{E(e,2,4,n,i);const t=e[0],s=N(e[1]);let o=Z(e[2],null);const y=H(Z(e[3],!0));if(o===null&&(o=["*"]),v(o)===!1)throw new m(n,p.InvalidParameter,i);if(e[0]===null)return null;if(!B(e[0]))throw new m(n,p.InvalidParameter,i);const u=t._layer;let l;if(S(u))l=u;else{if(u==null||!ge(u))return null;l=X(u,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}l=await l.load();const r=l.relationshipMetaData().filter(h=>h.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return We(l,r[0],t.field(l.objectIdField),l.spatialReference,o,y,n.lrucache,n.interceptor);let f=l.serviceUrl();if(!f)return null;f=f.charAt(f.length-1)==="/"?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString();const c=await He(f,l.spatialReference,o,y,n.lrucache,n.interceptor);await c.load();let A=c.relationshipMetaData();if(A=A.filter(h=>h.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const h=await l.getFeatureByObjectId(t.field(l.objectIdField),[r[0].keyField]);if(h){const D=x.create(A[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return D.parameters={id:h.attributes[r[0].keyField]},c.filter(D)}return new _e({parentfeatureset:c})}const g=x.create(A[0].keyField+"= @id",{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:t.field(r[0].keyField)},c.filter(g)})},a.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),a.functions.featuresetbyassociation=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{E(e,2,3,n,i);const t=e[0],s=Ne(N(Z(e[1],""))),o=C(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!B(e[0]))throw new m(n,p.InvalidParameter,i);let y=t._layer;if(y instanceof Fe&&(y=X(y,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),y===null||S(y)===!1)return null;await y.load();const u=y.serviceUrl(),l=await Ge(u,n.spatialReference,!0);if(l.unVersion>=8)return await $e(y,t,s,o,l,n,i);const r=l.associations;let f=null,c=null,A=!1;if(o!==null&&o!==""&&o!==void 0){for(const T of l.terminals)T.terminalName===o&&(c=T.terminalId);c===null&&(A=!0)}const g=r.getFieldsIndex(),h=g.get("TOGLOBALID").name,D=g.get("FROMGLOBALID").name,R=g.get("TOTERMINALID").name,K=g.get("FROMTERMINALID").name,q=g.get("FROMNETWORKSOURCEID").name,_=g.get("TONETWORKSOURCEID").name,O=g.get("ASSOCIATIONTYPE").name,be=g.get("ISCONTENTVISIBLE").name,Te=g.get("OBJECTID").name;for(const T of y.fields)if(T.type==="global-id"){f=t.field(T.name);break}let U=null,se=new z(new P({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),oe=new z(new P({name:"side",alias:"side",type:"string"}),x.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const L="globalid",le="globalId",fe={};for(const T in l.lkp)fe[T]=l.lkp[T].sourceId;const M=new Ve(new P({name:"classname",alias:"classname",type:"string"}),null,fe);let F="";switch(s){case"midspan":{F=`((${h}='${f}') OR ( ${D}='${f}')) AND (${O} IN (5))`,M.codefield=x.create(`CASE WHEN (${h}='${f}') THEN ${q} ELSE ${_} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const T=ie(k.findField(r.fields,D));T.name=L,T.alias=L,U=new z(T,x.create(`CASE WHEN (${D}='${f}') THEN ${h} ELSE ${D} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),se=l.unVersion>=4?new te(k.findField(r.fields,g.get("PERCENTALONG").name)):new z(new P({name:"percentalong",alias:"percentalong",type:"double"}),x.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${h}='${f}') OR ( ${D}='${f}')) AND (${O} IN (4,6))`,M.codefield=x.create(`CASE WHEN (${h}='${f}') THEN ${q} ELSE ${_} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const T=ie(k.findField(r.fields,D));T.name=L,T.alias=L,U=new z(T,x.create(`CASE WHEN (${D}='${f}') THEN ${h} ELSE ${D} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),oe=new z(new P({name:"side",alias:"side",type:"string"}),x.create(`CASE WHEN (${O}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let T=`${h}='@T'`,de=`${D}='@T'`;c!==null&&(T+=` AND ${R}=@A`,de+=` AND ${K}=@A`),F="(("+T+") OR ("+de+"))",F=Q(F,"@T",f??""),T=Q(T,"@T",f??""),c!==null&&(T=Q(T,"@A",c.toString()),F=Q(F,"@A",c.toString())),M.codefield=x.create("CASE WHEN "+T+` THEN ${q} ELSE ${_} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const Y=ie(k.findField(r.fields,D));Y.name=L,Y.alias=L,U=new z(Y,x.create("CASE WHEN "+T+` THEN ${D} ELSE ${h} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${h}='${f}' AND ${O} = 2`,c!==null&&(F+=` AND ${R} = `+c.toString()),M.codefield=q,F="( "+F+" )",U=new J(k.findField(r.fields,D),L,L);break;case"content":F=`(${D}='${f}' AND ${O} = 2)`,c!==null&&(F+=` AND ${K} = `+c.toString()),M.codefield=_,F="( "+F+" )",U=new J(k.findField(r.fields,h),L,L);break;case"structure":F=`(${h}='${f}' AND ${O} = 3)`,c!==null&&(F+=` AND ${R} = `+c.toString()),M.codefield=q,F="( "+F+" )",U=new J(k.findField(r.fields,D),L,le);break;case"attached":F=`(${D}='${f}' AND ${O} = 3)`,c!==null&&(F+=` AND ${K} = `+c.toString()),M.codefield=_,F="( "+F+" )",U=new J(k.findField(r.fields,h),L,le);break;default:throw new m(n,p.InvalidParameter,i)}return A&&(F="1 <> 1"),new k({parentfeatureset:r,adaptedFields:[new te(k.findField(r.fields,Te)),new te(k.findField(r.fields,be)),U,oe,M,se],extraFilter:F?x.create(F,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},a.signatures.push({name:"featuresetbyassociation",min:2,max:6}),a.functions.groupby=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,3,3,n,i),!S(e[0]))throw new m(n,p.InvalidParameter,i);const t=await e[0].load(),s=[],o=[];let y=!1,u=[];if(C(e[1]))u.push(e[1]);else if(e[1]instanceof j)u.push(e[1]);else if(v(e[1]))u=e[1];else{if(!W(e[1]))throw new m(n,p.InvalidParameter,i);u=e[1].toArray()}for(const l of u)if(C(l)){const r=x.create(N(l),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),f=we(r)===!0?N(l):"%%%%FIELDNAME";s.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(y=!0)}else{if(!(l instanceof j))throw new m(n,p.InvalidParameter,i);{const r=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",f=l.hasField("expression")?l.field("expression"):"";if(r==="%%%%FIELDNAME"&&(y=!0),!r)throw new m(n,p.InvalidParameter,i);s.push({name:r,expression:x.create(f||r,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(u=[],C(e[2]))u.push(e[2]);else if(v(e[2]))u=e[2];else if(W(e[2]))u=e[2].toArray();else{if(!(e[2]instanceof j))throw new m(n,p.InvalidParameter,i);u.push(e[2])}for(const l of u){if(!(l instanceof j))throw new m(n,p.InvalidParameter,i);{const r=l.hasField("name")?l.field("name"):"",f=l.hasField("statistic")?l.field("statistic"):"",c=l.hasField("expression")?l.field("expression"):"";if(!(r&&f&&C(f)&&c))throw new m(n,p.InvalidParameter,i);o.push({name:r,statistic:f,expression:x.create(c,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(y){const l={};for(const f of t.fields)l[f.name.toLowerCase()]=1;for(const f of s)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);let r=0;for(const f of s)if(f.name==="%%%%FIELDNAME"){for(;l["field_"+r.toString()]===1;)r++;l["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}for(const l of s)ae(l.expression,a,n);for(const l of o)ae(l.expression,a,n);return e[0].groupby(s,o)})},a.signatures.push({name:"groupby",min:3,max:3}),a.functions.distinct=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(S(e[0])){E(e,2,2,n,i);const t=await e[0].load(),s=[];let o=[];if(C(e[1]))o.push(e[1]);else if(e[1]instanceof j)o.push(e[1]);else if(v(e[1]))o=e[1];else{if(!W(e[1]))throw new m(n,p.InvalidParameter,i);o=e[1].toArray()}let y=!1;for(const u of o)if(C(u)){const l=x.create(N(u),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),r=we(l)===!0?N(u):"%%%%FIELDNAME";s.push({name:r,expression:l}),r==="%%%%FIELDNAME"&&(y=!0)}else{if(!(u instanceof j))throw new m(n,p.InvalidParameter,i);{const l=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",r=u.hasField("expression")?u.field("expression"):"";if(l==="%%%%FIELDNAME"&&(y=!0),!l)throw new m(n,p.InvalidParameter,i);s.push({name:l,expression:x.create(r||l,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(y){const u={};for(const r of t.fields)u[r.name.toLowerCase()]=1;for(const r of s)r.name!=="%%%%FIELDNAME"&&(u[r.name.toLowerCase()]=1);let l=0;for(const r of s)if(r.name==="%%%%FIELDNAME"){for(;u["field_"+l.toString()]===1;)l++;u["field_"+l.toString()]=1,r.name="FIELD_"+l.toString()}}for(const u of s)ae(u.expression,a,n);return e[0].groupby(s,[])}return Je(e)})},a.functions.getfeaturesetinfo=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,1,1,n,i),!S(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?j.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ce(n),!1,!1):null})},a.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),a.functions.filterbysubtypecode=function(n,i){return a.standardFunctionAsync(n,i,async(I,b,e)=>{if(E(e,2,2,n,i),S(e[0])){const t=await e[0].load(),s=e[1];if(!Ae(s))throw new m(n,p.InvalidParameter,i);if(t.subtypeField){const y=x.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:y})}if(t.typeIdField===null||t.typeIdField==="")throw new m(n,p.FeatureSetDoesNotHaveSubtypes,i);const o=x.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ne({parentfeatureset:e[0],whereclause:o})}throw new m(n,p.InvalidParameter,i)})},a.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{bn as registerFunctions};
